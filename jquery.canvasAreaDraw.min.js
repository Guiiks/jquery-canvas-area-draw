!function(a){a.fn.canvasAreaDraw=function(a){this.each(function(c,d){b.apply(d,[c,d,a])})};var b=function(b,d,e){var f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v=!1;h=a.extend({imageUrl:a(this).attr("data-image-url")},e);var w=a(d).val().replace(/[^0-9\,]/gi,"");f=w.length?w.split(",").map(function(a){return parseInt(a,10)}):[],i=a('<button type="button" class="btn"><i class="icon-trash"></i>Очистить</button>'),j=a("<canvas>"),k=j[0].getContext("2d"),l=new Image,r=function(){j.attr("height",l.height).attr("width",l.width),m()},a(l).on("load",r),l.src=h.imageUrl,l.loaded&&r(),j.css({background:"url("+l.src+")"}),a(d).after("<br>",j,"<br>",i),s=function(){f=[],m()},p=function(b){b.offsetX||(b.offsetX=b.pageX-a(b.target).offset().left,b.offsetY=b.pageY-a(b.target).offset().top),f[g]=Math.round(b.offsetX),f[g+1]=Math.round(b.offsetY),m()},q=function(b){b.offsetX||(b.offsetX=b.pageX-a(b.target).offset().left,b.offsetY=b.pageY-a(b.target).offset().top),v||(v={x:Math.round(b.offsetX),y:Math.round(b.offsetY)});for(var c={x:Math.round(b.offsetX),y:Math.round(b.offsetY)},d=0;d<f.length;d++)f[d]=c.x-v.x+f[d],f[++d]=c.y-v.y+f[d];v=c,m()},o=function(){a(this).off("mousemove"),u(),g=null},t=function(b){b.preventDefault(),b.offsetX||(b.offsetX=b.pageX-a(b.target).offset().left,b.offsetY=b.pageY-a(b.target).offset().top);for(var c=b.offsetX,d=b.offsetY,e=0;e<f.length;e+=2)if(dis=Math.sqrt(Math.pow(c-f[e],2)+Math.pow(d-f[e+1],2)),dis<6)return f.splice(e,2),m(),u(),!1;return!1},n=function(b){var d,e,h,i,j=f.length;if(3===b.which)return!1;if(b.preventDefault(),b.offsetX||(b.offsetX=b.pageX-a(b.target).offset().left,b.offsetY=b.pageY-a(b.target).offset().top),d=b.offsetX,e=b.offsetY,f.length>=6){var l=getCenter();if(k.fillRect(l.x-4,l.y-4,8,8),h=Math.sqrt(Math.pow(d-l.x,2)+Math.pow(e-l.y,2)),6>h)return v=!1,a(this).on("mousemove",q),!1}for(var n=0;n<f.length;n+=2)if(h=Math.sqrt(Math.pow(d-f[n],2)+Math.pow(e-f[n+1],2)),6>h)return g=n,a(this).on("mousemove",p),!1;for(var n=0;n<f.length;n+=2)n>1&&(i=c(d,e,f[n],f[n+1],f[n-2],f[n-1],!0),6>i&&(j=n));return f.splice(j,0,Math.round(d),Math.round(e)),g=j,a(this).on("mousemove",p),m(),u(),!1},m=function(){if(k.canvas.width=k.canvas.width,u(),!(f.length<2)){if(k.globalCompositeOperation="destination-over",k.fillStyle="rgb(255,255,255)",k.strokeStyle="rgb(255,20,20)",k.lineWidth=1,f.length>=6){var a=getCenter();k.fillRect(a.x-4,a.y-4,8,8)}k.beginPath(),k.moveTo(f[0],f[1]);for(var b=0;b<f.length;b+=2)k.fillRect(f[b]-2,f[b+1]-2,4,4),k.strokeRect(f[b]-2,f[b+1]-2,4,4),f.length>2&&b>1&&k.lineTo(f[b],f[b+1]);k.closePath(),k.fillStyle="rgba(255,0,0,0.3)",k.fill(),k.stroke()}},u=function(){a(d).val(f.join(","))},getCenter=function(){var a=[];for(l=0;l<f.length;l++)a.push({x:f[l],y:f[++l]});var b=a[0],c=a[a.length-1];(b.x!=c.x||b.y!=c.y)&&a.push(b);for(var d,e,g,h=0,i=0,j=0,k=a.length,l=0,m=k-1;k>l;m=l++)d=a[l],e=a[m],g=d.x*e.y-e.x*d.y,h+=g,i+=(d.x+e.x)*g,j+=(d.y+e.y)*g;return g=3*h,{x:i/g,y:j/g}},a(d).on("change",function(){var b=a(d).val().replace(/[^0-9\,]/gi,"");f=b.length?b.split(",").map(function(a){return parseInt(a,10)}):[],m()}),a(document).find(i).click(s),a(document).find(j).on("mousedown",n),a(document).find(j).on("contextmenu",t),a(document).find(j).on("mouseup",o)};a(document).ready(function(){a(".canvas-area[data-image-url]").canvasAreaDraw()});var c=function(a,b,c,d,e,f,g){function h(a,b,c,d){return Math.sqrt((a-=c)*a+(b-=d)*b)}if(!g||(g=function(a,b,c,d,e,f){if(!(e-c))return{x:c,y:b};if(!(f-d))return{x:a,y:d};var g,h=-1/((f-d)/(e-c));return{x:g=(e*(a*h-b+d)+c*(a*-h+b-f))/(h*(e-c)+d-f),y:h*g-h*a+b}}(a,b,c,d,e,f),g.x>=Math.min(c,e)&&g.x<=Math.max(c,e)&&g.y>=Math.min(d,f)&&g.y<=Math.max(d,f))){var i=d-f,j=e-c,k=c*f-d*e;return Math.abs(i*a+j*b+k)/Math.sqrt(i*i+j*j)}var l=h(a,b,c,d),m=h(a,b,e,f);return l>m?m:l}}(jQuery);